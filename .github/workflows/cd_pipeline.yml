# This workflow will do a clean installation of node dependencies, cache/restore them, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: ciroh-ua-website-cd

on:
  repository_dispatch:
    types: [build-completed]
  workflow_dispatch:  # For manual triggering if needed
  
jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-outputs.outputs.environment }}
      version: ${{ steps.set-outputs.outputs.version }}
      
    name: ${{ github.event.client_payload.env }} - Deploy ${{ github.event.client_payload.short_hash }} from ${{ github.event.client_payload.branch }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Ensure detached HEAD state to avoid conflicts with the main branch
          ref: refs/heads/main

      # Get environment and version from dispatch payload
      - name: Set environment from dispatch
        run: |
          echo "Deploying commit ${{ github.event.client_payload.commit_hash }}"
          echo "Commit message: ${{ github.event.client_payload.commit_message }}"
          echo "Branch: ${{ github.event.client_payload.branch }}"
          echo "DEPLOY_ENV=${{ github.event.client_payload.env }}" >> $GITHUB_ENV
          echo "VERSION=${{ github.event.client_payload.version }}" >> $GITHUB_ENV
          echo "Deploying version: ${{ github.event.client_payload.version }}"
          echo "Environment: ${{ github.event.client_payload.env }}"
          
      # https://github.com/marketplace/actions/download-workflow-artifact
      - name: Download a Build Artifact
        uses: dawidd6/action-download-artifact@v2.26.1
        with:
          workflow: ci_pipeline.yml
          name: build-${{ env.DEPLOY_ENV }}
          path: ./build/

      - name: Set deployment target
        id: set-outputs
        run: |
          if [[ "$DEPLOY_ENV" == "production" ]]; then
            echo "ENVIRONMENT=production" >> $GITHUB_ENV
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "Deploying to PRODUCTION environment (current repo)"
          else
            echo "ENVIRONMENT=staging" >> $GITHUB_ENV
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "TARGET_REPO=CIROH-UA/ciroh_hub_staging" >> $GITHUB_ENV
            echo "Deploying to STAGING environment"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # Staging: Deploy to target repo (keep existing behavior)
      - name: GitHub Pages deployment to staging
        uses: JamesIves/github-pages-deploy-action@v4.6.1
        if: ${{ env.ENVIRONMENT == 'staging' }}
        with:
          token: ${{ secrets.GH_STAGING_TOKEN }}
          branch: main
          folder: build
          repository-name: ${{ env.TARGET_REPO }}

      # Production: Upload pages artifact for deployment in current repo
      - name: Upload pages artifact for production
        if: ${{ env.ENVIRONMENT == 'production' }}
        uses: actions/upload-pages-artifact@v3
        with:
          path: build

      - name: Post-deployment notification
        run: |
          if [[ "${{ env.ENVIRONMENT }}" == "production" ]]; then
            echo "### Production build artifact uploaded! ðŸš€" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Production build artifact uploaded. Deployment to GitHub Pages will complete in the next job." >> $GITHUB_STEP_SUMMARY
          else
            echo "Staging deployment completed successfully!"
            echo "To deploy to production, manually trigger the workflow and select 'production'"
          fi

  deploy-production:
    name: Deploy Production to GitHub Pages
    needs: deploy
    if: needs.deploy.outputs.environment == 'production'
    runs-on: ubuntu-latest
    
    permissions:
      pages: write
      id-token: write
    
    environment:
      name: production
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Deployment Summary
        run: |
          echo "### Production Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.deploy.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY